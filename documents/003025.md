# å¹¶å‘ä»»åŠ¡çš„æ§åˆ¶

ğŸ‘‰ åœ¨å¼‚æ­¥ä»»åŠ¡æœ‰ä½¿ç”¨åˆ° `await` å…³é”®å­—çš„åœ°æ–¹éƒ½éœ€è¦åŒ…è£¹å®ƒçš„å‡½æ•°å£°æ˜æˆ `async`

```javascript
function timeout(time) {
  return new Promise((resolve) => {
    setTimeout(() => {
      resolve();
    }, time);
  });
}

class SuperTask {
  constructor(parallelCount = 2) {
    this.parallelCount = parallelCount; // æ”¯æŒçš„æœ€å¤§å¹¶å‘ä»»åŠ¡æ•°
    this.tasks = []; // è®°å½•æ‰€æœ‰çš„å¹¶å‘ä»»åŠ¡
    this.runningCount = 0; // æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡æ•°é‡
  }

  // æ·»åŠ ä»»åŠ¡åˆ°ä»»åŠ¡é˜Ÿåˆ—
  add(task) {
    return new Promise((resolve, reject) => {
      this.tasks.push({
        task,
        resolve,
        reject,
      });
      this._run();
    });
  }

  // æ‰§è¡Œä»»åŠ¡
  _run() {
    while (this.tasks.length > 0 && this.runningCount < this.parallelCount) {
      const { task, resolve, reject } = this.tasks.shift();
      // æ‰§è¡Œ
      task()
        .then(resolve, reject)
        .finally(() => {
          this.runningCount--;
          this._run();
        });

      this.runningCount++;
    }
  }
}

const superTask = new SuperTask();

function addTask(time, name) {
  superTask
    .add(() => timeout(time))
    .then(() => {
      console.log(`ä»»åŠ¡${name}å®Œæˆ`);
    });
}

addTask(10000, 1); // 10000msåè¾“å‡ºï¼šä»»åŠ¡1å®Œæˆ
addTask(5000, 2); // 5000msåè¾“å‡ºï¼šä»»åŠ¡2å®Œæˆ
addTask(3000, 3); // 8000msåè¾“å‡ºï¼šä»»åŠ¡3å®Œæˆ
addTask(4000, 4); // 12000msåè¾“å‡ºï¼šä»»åŠ¡4å®Œæˆ
addTask(5000, 5); // 15000msåè¾“å‡ºï¼šä»»åŠ¡5å®Œæˆ
```
