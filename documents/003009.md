# 浏览器渲染机制

[浏览器的工作原理](https://developer.mozilla.org/zh-CN/docs/Web/Performance/%E6%B5%8F%E8%A7%88%E5%99%A8%E6%B8%B2%E6%9F%93%E9%A1%B5%E9%9D%A2%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86)

[从浏览器多进程到 JS 单线程，JS 运行机制最全面的一次梳理](https://dailc.github.io/2018/01/21/js_singlethread_eventloop.html)

## 一. 渲染进程

* 浏览器是多进程的
* 前端开发最关注的是: 浏览器内核(`渲染进程`)
* 浏览器的渲染进程是`多线程`的

<p align="center"><img src=https://linmingdao.github.io/blog/assets/tech/003009_00.png></p>

### 1. GUI 渲染线程

* 负责渲染浏览器界面，解析 HTML，CSS，构建 DOM 树和 RenderObject 树，布局和绘制等。
* 当界面需要重绘（Repaint）或由于某种操作引发回流(reflow)时，该线程就会执行
* 注意，GUI 渲染线程与 JS 引擎线程是互斥的，当 JS 引擎执行时 GUI 线程会被挂起（相当于被冻结了），GUI 更新会被保存在一个队列中等到 JS 引擎空闲时立即被执行。

### 2. JS 引擎线程

* 也称为 JS 内核，负责处理 Javascript 脚本程序。（例如 V8 引擎）
* JS 引擎线程负责解析 Javascript 脚本，运行代码。
* JS 引擎一直等待着任务队列中任务的到来，然后加以处理，一个 Tab 页（renderer 进程）中无论什么时候都只有一个 JS 线程在运行 JS 程序
* 同样注意，GUI 渲染线程与 JS 引擎线程是互斥的，所以如果 JS 执行的时间过长，这样就会造成页面的渲染不连贯，导致页面渲染加载阻塞。

### 3. 事件触发线程

* 归属于浏览器而不是 JS 引擎，用来控制事件循环（可以理解，JS 引擎自己都忙不过来，需要浏览器另开线程协助）
* 当 JS 引擎执行代码块如 setTimeOut 时（也可来自浏览器内核的其他线程, 如鼠标点击、AJAX 异步请求等），会将对应任务添加到事件线程中
* 当对应的事件符合触发条件被触发时，该线程会把事件添加到待处理队列的队尾，等待 JS 引擎的处理
* 注意，由于 JS 的单线程关系，所以这些待处理队列中的事件都得排队等待 JS 引擎处理（当 JS 引擎空闲时才会去执行）

### 4. 定时触发器线程

* 传说中的 setInterval 与 setTimeout 所在线程
* 浏览器定时计数器并不是由 JavaScript 引擎计数的, （因为 JavaScript 引擎是单线程的, 如果处于阻塞线程状态就会影响记计时的准确）
* 因此通过单独线程来计时并触发定时（计时完毕后，添加到事件队列中，等待 JS 引擎空闲后执行）
* 注意，W3C 在 HTML 标准中规定，规定要求 setTimeout 中低于 4ms 的时间间隔算为 4ms。

### 5. 异步 http 请求线程

* 在 XMLHttpRequest 在连接后是通过浏览器新开一个线程请求
* 将检测到状态变更时，如果设置有回调函数，异步线程就产生状态变更事件，将这个回调再放入事件队列中。再由 JavaScript 引擎执行。

## 二. 渲染页面的过程

<p align="center"><img src=https://linmingdao.github.io/blog/assets/tech/003009_01.png></p>

### 1. 构建 DOM 树 (DOM Tree) 的过程

* 当解析器发现 `非阻塞资源`，例如一张图片，浏览器会请求这些资源并且继续解析。当遇到一个 CSS 文件时，解析也可以继续进行
* 但是对于 script 标签（特别是没有 async 或者 defer 属性）会阻塞渲染并停止 HTML 的解析。尽管浏览器的 预加载扫描器 加速了这个过程，但过多的脚本仍然是一个重要的瓶颈。
* 即: 构建 DOM Tree 的过程中, Script 会阻塞解析, 图片 和 样式 不会阻塞解析

预加载扫描器 (一个单独的线程)

```
浏览器构建 DOM 树时，这个过程占用了主线程。

当这种情况发生时，预加载扫描仪将解析可用的内容并请求高优先级资源，如 CSS、JavaScript 和 web 字体。多亏了预加载扫描器，我们不必等到解析器找到对外部资源的引用来请求它。

它将在后台检索资源，以便在主 HTML 解析器到达请求的资源时，它们可能已经在运行，或者已经被下载。预加载扫描仪提供的优化减少了阻塞。
```
