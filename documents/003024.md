# å¤§é‡ä»»åŠ¡æ‰§è¡Œçš„è°ƒåº¦

<p align="center"><img src=https://linmingdao.github.io/blog/assets/tech/003024_01.png></p>

<p align="center"><img src=https://linmingdao.github.io/blog/assets/tech/003024_01.png></p>

## ä¸€ã€å¼‚æ­¥çš„ä¼ æŸ“æ€§

ğŸ‘‰ åœ¨å¼‚æ­¥ä»»åŠ¡æœ‰ä½¿ç”¨åˆ° `await` å…³é”®å­—çš„åœ°æ–¹éƒ½éœ€è¦åŒ…è£¹å®ƒçš„å‡½æ•°å£°æ˜æˆ `async`

```javascript
// æ¨¡æ‹Ÿçš„å¼‚æ­¥ä»»åŠ¡
function myfetch() {
  return new Promise((resolve, reject) => {
    setTimeout(() => resolve(['å°çº¢', 'å°æ˜', 'å°æ']), 3000);
  });
}

async function getUser() {
  return await myfetch();
}

async function m1() {
  return await getUser();
}

async function m2() {
  return await getUser();
}

async function m3() {
  return await getUser();
}

async function main() {
  const user = await m3();
  console.log(user);
}

main();
```

## äºŒã€æ¶ˆé™¤å¼‚æ­¥çš„ä¼ æŸ“æ€§

ğŸ‘‰ æ€è·¯

<p align="center"><img src=https://linmingdao.github.io/blog/assets/tech/003023_01.png></p>

ğŸ‘‰ å®ç°

```javascript
function myfetch() {
  return new Promise((resolve, reject) => {
    setTimeout(() => resolve(['å°çº¢', 'å°æ˜', 'å°æ']), 3000);
  });
}

function getUser() {
  return myfetch();
}

function m1() {
  return getUser();
}

function m2() {
  return getUser();
}

function m3() {
  return getUser();
}

function main() {
  const user = m3();
  console.log('user', user);
}

// æ„é€ ä¸€ä¸ªæ‰§è¡Œ main çš„ä¸Šä¸‹æ–‡ç¯å¢ƒ
function run(func) {
  let cache = [];
  let i = 0;

  // ä¿ç•™åŸå§‹çš„ myfetch
  const originalMyFetch = myfetch;
  // é‡å†™ myfetch
  myfetch = (...args) => {
    // å¦‚æœæœ‰ç¼“å­˜ï¼Œåˆ™ç›´æ¥ä»ç¼“å­˜è¿”å›æ•°æ®
    if (cache[i] && cache[i].status === 'fulfilled') {
      return cache[i].data;
    } else if (cache[i] && cache[i].status === 'rejected') {
      throw cache[i].err;
    }

    // å¦‚æœæ²¡æœ‰ç¼“å­˜ï¼Œåˆ™å‘èµ·è¯·æ±‚ï¼Œå¹¶ç›´æ¥æŠ›å¼‚å¸¸
    const result = {
      status: 'pending',
      data: null,
      err: null,
    };
    cache[i++] = result;

    // ä½¿ç”¨åŸå§‹çš„ myfetch å‘é€è¯·æ±‚
    const promise = originalMyFetch(...args)
      .then((resp) => {
        result.status = 'fulfilled';
        result.data = resp;
      })
      .catch((err) => {
        result.status = 'rejected';
        result.err = err;
      });

    // æŠ¥é”™
    throw promise;
  };

  try {
    // ç¬¬ä¸€æ¬¡æ‰§è¡Œ funcï¼Œç›®çš„æ˜¯ï¼šè§¦å‘å¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡Œ
    func();
  } catch (err) {
    if (err instanceof Promise) {
      const reRun = () => {
        i = 0;
        // ç¬¬äºŒæ¬¡æ‰§è¡Œ funcï¼Œç›®çš„æ˜¯ï¼šä»å·²ç»å›æ¥çš„å¼‚æ­¥ä»»åŠ¡ç¼“å­˜ä¸­è·å–è¿”å›å€¼
        func();
      };
      err.then(reRun).catch(reRun);
    }
  }
}

run(main);
```
