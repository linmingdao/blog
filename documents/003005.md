# webpack 之重要概念

## 一、webpack webpack-cli

* webpack 和 webpack-cli
* 不应该全局安装webpack，webpack应该跟项目绑定
* 去了解 npx vs npm
  + npm 永久安裝，npx 安裝後即移除
  + 更方便的運行本地套件
  + npx webpack -v
* 去了解 npm script

## 二、Concepts

* Entry
* Output
* Loaders
* Plugins
* Mode
* Browser Compatibility

## 三、Loader

处理图片，字体

* url-loader
* file-loader

处理样式

* css-loader
* style-loader
  + importLoaders: 2
  + modules: true (style-loader 支持 css modules 特性，解决样式冲突)
* sass-loader
* postcss-loader -> plugins: [autoprefixer]
* less-loader

## 四、Plugins

* HtmlWebpackPlugin, ejs模板语法
* CleanWebpackPlugin（非官方plugin）

ejs模板语法

``` html
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <link rel="icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <% if(htmlWebpackPlugin.options.fetchAuthByIFrame == 'yes') { %>
    <script>
        window.onload = function() {
            window.frames[0].postMessage(
                'AuthorizationOPM',
                '<%= htmlWebpackPlugin.options.authAddr %>',
            );
        };
        window.addEventListener(
            'message',
            function(e) {
                const data = e.data;
                if (data.AuthorizationOPM) {
                    localStorage.setItem('AuthorizationOPM', data.AuthorizationOPM);
                }
            },
            false,
        );
    </script>
    <% } %>
    <title><%= htmlWebpackPlugin.options.title %></title>
    <!-- 引入样式 -->
    <% for(var css of htmlWebpackPlugin.options.static.styles) { %>
    <link rel="stylesheet" href="<%=css%>" />
    <% } %>
    <!-- 引入js -->
    <% for(var js of htmlWebpackPlugin.options.static.scripts) { %>
    <script src="<%=js%>"></script>
    <% } %>
</head>

<body style="background-color: #eee">
    <% if(htmlWebpackPlugin.options.fetchAuthByIFrame == 'yes') { %>
    <div id="opm-auth" style="
        position: absolute;
        height: 500px;
        line-height: 500px;
        width: 600px;
        text-align: center;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        background-color: #f5f5f500;
        z-index: 100;
        color: #1990ff;
      ">
        <%= htmlWebpackPlugin.options.authMsg %>
    </div>
    <iframe src="<%= htmlWebpackPlugin.options.authAddr %>" style="width: 0; height: 0px; visibility: hidden"></iframe>
    <% } %>
    <div id="app"></div>
</body>

</html>
```

## 五、Entry 和 Output

``` javascript
{
    entry: {
        // entry: './src/index.js' 默认就是 entry: { main: './src/index.js' }
        main: './src/index.js',
        sub: './src/index.js',
    },
    output: {
        publicPath: 'http://cdn.com.cn',
        filename: '[name].js',
        path: path.resolve(__dirname, 'dist')
    }
}
```

## 六、SourceMap

``` javascript
{
    devtool: 'none'
}
```

devtool

* none
* source-map：生成单独得代码映射文件
* inline-source-map：映射文件会被内敛放在打包文件底部
* cheap-source-map：source-map映射精确到行和列，加上 cheap- 前缀告诉精确到行就行了，并且 cheap- 只会报业务代码里面的错误，loader打包过程的错误不会报
* cheap-module-source-map：正常情况下，只做自己业务代码的映射，module- 前缀会额外做第三方库的映射，并且会报除了业务代码以外一些loader的错误
* eval：是打包最快的方式，但是会忽略一些细节

最佳实践：

``` javascript
// 开发模式
{
    mode: 'devalopment',
    devtool: 'cheap-module-eval-source-map'
}

// 生产模式
{
    mode: 'production',
    devtool: 'cheap-module-source-map'
}
```

## 七、WebpackDevServer

最原始的方式：

``` javascript
{
    "script": {
        "watch": "webpack --watch"
    }
}
```

devServer:

``` javascript
// npm install webpack-dev-server -D

{
    "script": {
        "start": "webpack-dev-server"
    }
}

{
    devServer: {
        // 表示服务器要启在哪个文件夹下，用于提供服务器的静态资源文件
        contentBase: './dist',
        open: true,
        port: 8080,
        proxy: {
            '/api': 'http://localhost:3000'
        }
    }
}
```

借助如下工具自己实现 webpack-dev-server 功能：

express、webpack、webpack.config.js、webpack-dev-meddleware

``` javascript
{

    "script": {
        "server": "node server.js"
    }

}
```

## 八、HMR（Hot Module Replacement）

``` javascript
{
    devServer: {
        contentBase: './dist',
        open: true,
        port: 8080,
        hot: true,
        hotOnly: true, // 即使 HMR 不生效，浏览器也不自动刷新
        proxy: {
            '/api': 'http://localhost:3000'
        }
    },
    plugins: [
        // ...
        new webpack.HotModuleReplacementPlugin()
    ]
}
```

上面的配置样式的 HMR 已经支持了（原因是 css-loader 底层帮你实现了），js 的 HMR

``` javascript
import counter from './counter';
import number from './number';

counter();
number();

if (module.hot) {
    module.hot.accept('./number', () => {
        number();
    });
}
```

同理，vue-loader 等一些官方 loader 或 一些脚手架会帮助开发中实现 HMR 功能

## 九、Babel

``` shell
npm install --save-dev babel-loader @babel/core
```

``` shell
npm install @babel/preset-env --save-dev
```

@babel/polyfill: we need it to be a dependency

``` shell
npm install --save @babel/polyfill
```
